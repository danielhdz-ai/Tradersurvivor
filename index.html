<!DOCTYPE html>
<html lang="es">
<cabeza>
    <meta conjunto de caracteres=„UTF-8">
    <meta nombre="ventana gráfica" contenido="ancho=ancho del dispositivo, escala inicial=1.0">
    <tipulo>Trader Survivor - Revista Comercial Profesional V2</tipulo>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="hoja de estilo">
    <link rel="hoja de estilo" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.2/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <!-- Incluir Dexie.js (para configuración local) -->
    <script src="https://unpkg.com/dexie@3/dist/dexie.js"></script>
    <!-- Incluir Supabase JS SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <estilo>
 /* Paleta de colores: Negro, Verde Fluorescente y Blanco */
 :raíz {
 --primaria: #39ff14; --secundaria: #28e000; --fondo: #0a0a0a; --superficie: #141414; --luz superficial: #2a2a2a;
 --texto: #ffffff; --texto secundario: #a0a0a0; --rojo: #ff4136; --verde: #39ff14; --amarillo: #f59e0b;
        }
 .texto positivo { color: var(--verde); } .texto negativo { color: var(--rojo); } .texto neutro { color: var(--texto secundario); }
 cuerpo { familia de fuentes: 'Interfaz de usuario de Segoe', 'Roboto', sistema-ui, -sistema-manzana, sans-serif; color de fondo: var(--fondo); color: var(--texto); marca: 0; aclamado: 0; }
 .app-container-wrapper { visualizar: ninguno; }
 .app-container { ancho máximo: 1600px; margen: 0 auto; acompañado: 1.5rem; }
 .nav-tabs { borde inferior: 1px sólido var(--luz superficial); }
 .nav-tab { acercado: 0,75rem 1.5rem; cursor: apostador; transición: todos 0,2s entrada-salida; color: var(--texto secundario); borde inferior: 3px sólido transparente; marca inferior: -1px; espacio en blanco: nowrap; }
 .nav-tab.activo { color: var(--texto); borde-color-inferior: var(--primaria); peso de fuente: 600; }
 .nav-tab:hover:no(.activo) { color: var(--texto); borde-color-inferior: var(--luz superficial); }
 .sección-contenido { visualizar: ninguno; acompañado: 1.5rem 0; margen inferior: 2rem; }
 .sección-contenido.activo { visualizar: bloque; }
 .tarjeta métrica, .account-card { color de fondo: var(--superficie); radio fronterizo: 0,5rem; acompañado: 1,5rem; frontera: 1px sólido var(--luz superficial); transición: todos 0,2s entrada-salida; }
 .tarjeta métrica:hover, .account-card:hover { color del borde: var(--primaria); caja-sombra: 0 0 20px rgba(57, 255, 20, 0,1); transformar: traducirY(-2px); }
 .account-card.seleccionado { color del borde: var(--primaria); caja-sombra: 0 0 25px rgba(57, 255, 20, 0,15); }
 .día calendario { ancho: 100%; relación de aspecto: 1 / 1; visualizar: flex; flex-direction: columna; align-items: centro; justificar-contenido: centro; radio fronterizo: 0,25rem; cursor: apostero; transición: todos 0,2s facilidad; posición: relativo; color de fondo: var(--superficie); frontera: 1px sólido var(--superficie-luz); }
 .día calendario.vacío { color de fondo: transparente; color del borde: var(--fondo); cursor: predeterminado; } .día calendario.vacío:hover { transformar: ninguno; }
 .día calendario.beneficio { color de fondo: rgba(57, 255, 20, 0,05); color del borde: var(--verde); }
 .día calendario.pérdida { color de fondo: rgba(255, 65, 54, 0,05); color del borde: var(--rojo); }
 .día calendario:no(.vacío):hover { transformar: escala(1.05); índice z: 10; color del borde: var(--primaria); }
 .número de día { tamaño de fuente: 1,2rem; peso de fuente: 600; }
 botón { color de fondo: var(--luz superficial); color: var(--texto); frontera: 1px sólido var(--luz superficial); radio frontera: 0,25rem; acompañado: 0,6rem 1.2rem; cursor: apostador; transición: todos 0,2s facilidad; peso de fuente: 500; }
 botón:hover { color de fondo: var(--primaria); color del borde: var(--primaria); color: var(--fondo); peso de fuente: negrita; }
        botón.primario { color de fondo: var(--primaria); color del borde: var(--primaria); color: var(--fondo); font-weight: bold; }
        botón.peligro { color de fondo: var(--rojo); color del borde: var(--rojo); }
        #tabla de operaciones td botón, #cuentas-contenedor botón, #finanzas-tabla-cuerpo td botón { acolchado: 0,3rem 0,6rem; tamaño de fuente: 0,875rem; color de fondo: transparente; frontera: ninguno; }
        #tabla de operaciones td botón:hover, #cuentas-contenedor botón:hover, #finanzas-tabla-cuerpo td botón:hover { opacidad: 0,8; color: var(--primaria); }
        entrada, seleccionar, área de texto { color de fondo: var(--superficie); color: var(--texto); frontera: 1px sólido var(--luz superficial); radio fronterizo: 0,25rem; acolchado: 0,6rem; ancho: 100%; transición: color del borde 0,2s ease; }
        entrada:enfoque, seleccionar:enfoque, área de texto:enfoque { outline: ninguno; color del borde: var(--primaria); }
        tabla { ancho: 100%; colapso fronterizo: separado; border-spacing: 0; }
        th { alineación de texto: izquierda; acolchado: 0,8rem 1rem; font-weight: 600; color: var(--texto secundario); transformación de texto: mayúscula; tamaño de fuente: 0,75rem; espaciado entre letras: 0,05em; borde inferior: 1px sólido var(--luz superficial); }
        td { acolchado: 0,8rem 1rem; borde inferior: 1px sólido var(--superficie); rebosar: oculto; desbordamiento de texto: elipsis; espacio en blanco: nowrap; alineación vertical: medio; }
        tr:hover td { color de fondo: rgba(57, 255, 20, 0,03); }
        #tabla de operaciones tr.cursor-puntero:hover td, #mejores oficios tr.cursor-puntero:hover td, #peores oficios tr.cursor-puntero:hover td, #mesa-cuerpo-modal-diurno tr.cursor-puntero:hover td { color de fondo: rgba(57, 255, 20, 0,08); }
        .cambio de moneda { visualizar: flex en línea; rebosar: oculto; radio fronterizo: 0,25rem; color de fondo: var(--superficie); frontera: 1px sólido var(--luz superficial); }
        .cambio de moneda etiqueta { acolchado: 0,5rem 1rem; cursor: puntero; transición: todos 0,2s ease; color: var(--texto secundario); tamaño de fuente: 0,875rem; }
        .cambio de moneda entrada[tipo="radio"] { visualizar: ninguno; }
        .cambio de moneda entrada[tipo="radio"]:comprobado + etiqueta { color de fondo: var(--primaria); color: var(--fondo); font-weight: 600; }
        .chart-container { position: relative; height: 320px; margin-bottom: 1rem; }
        .loading { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(10, 10, 10, 0.9); display: flex; align-items: center; justify-content: center; z-index: 2001; }
        .spinner { border: 4px solid var(--surface-light); border-radius: 50%; border-top: 4px solid var(--primary); width: 50px; height: 50px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .image-modal { display: none; position: fixed; z-index: 2002; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.95); align-items: center; justify-content: center; }
        .image-modal-content { max-width: 90%; max-height: 90%; border-radius: 5px; }
        .image-modal-close { position: absolute; top: 15px; right: 35px; color: #f1f1f1; font-size: 40px; font-weight: bold; cursor: pointer; }
        #day-detail-modal { background-color: rgba(0,0,0,0.8); z-index: 2003; }
        #day-detail-modal > div { background-color: var(--surface); border: 1px solid var(--surface-light); }
    </style>
</head>
<body>
    <div id="loading" class="loading"><div class="spinner"></div></div>
    <div class="app-container-wrapper">
        <div class="app-container">
            <!-- El contenido de la app se renderiza aquí por JS -->
        </div>
    </div>
    
    <script>
    // --- Supabase Initialization ---
    const SUPABASE_URL = 'https://gakiamardmlgftfrlxkm.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imdha2lhbWFyZG1sZ2Z0ZnJseGttIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMwMjczMzUsImV4cCI6MjA2ODYwMzMzNX0.wR3c9DMtSXzoagFDJdrmYqnN6vjfQMn8ijtUdOSpmYM';
    const supabase = Supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // --- MODO DE DESARROLLO / USUARIO FIJO ---
    const DEV_USER_EMAIL = 'danielhernandezhv3@gmail.com';
    const DEV_USER_PASSWORD = 'Disarm12345.';
    
    // --- Global State ---
    const DB = {
        accounts: [],
        operations: [],
        finances: [],
        settings: { showTooltips: true, defaultCurrency: 'USD' },
        user: null
    };

    const dexieDB = new Dexie('TraderSurvivorDB_local_config');
    dexieDB.version(1).stores({ generalData: 'key' });

    let globalDateFilter = { type: 'all', startDate: null, endDate: null, display: 'Sin filtro de fecha' };
    let popupCalendarStateDate = new Date();
    const monthNamesShort = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
    let currentEditingOpImages = [];
    let modalImageList = [];
    let modalImageIndex = 0;
    let activeCharts = {};

    // --- HTML Template Functions ---
    function getAppHTML() {
        return `
        <header class="flex flex-wrap justify-between items-center mb-6 gap-4 p-4">
            <h1 class="text-3xl font-bold flex items-center text-white"><i class="fas fa-rocket mr-4 text-primary"></i> Trader Survivor</h1>
            <div id="auth-section" class="flex items-center space-x-2"></div>
            <div class="currency-switch">
                <input type="radio" id="usd" name="currency" value="USD" checked><label for="usd">USD</label>
                <input type="radio" id="eur" name="currency" value="EUR"><label for="eur">EUR</label>
                <input type="radio" id="percentage" name="currency" value="%"><label for="percentage">%</label>
            </div>
        </header>
        <div class="app-inner-container">
            <nav class="mb-6 overflow-x-auto"><div class="nav-tabs flex">
                <div class="nav-tab active" data-target="dashboard">Dashboard</div><div class="nav-tab" data-target="analytics">Analytics</div><div class="nav-tab" data-target="calendar">Calendario</div><div class="nav-tab" data-target="operations">Operaciones</div><div class="nav-tab" data-target="accounts">Cuentas</div><div class="nav-tab" data-target="finances">Finanzas</div><div class="nav-tab" data-target="news">Noticias</div><div class="nav-tab" data-target="config">Configuración</div>
            </div></nav>
            ${getAllSectionsHTML()}
        </div>
        ${getAllModalsHTML()}
        `;
    }
        
    function getAllSectionsHTML() {
        return `
            <section id="dashboard" class="section-container active"></section>
            <section id="analytics" class="section-container"></section>
            <section id="calendar" class="section-container"></section>
            <section id="operations" class="section-container"></section>
            <section id="operation-detail-page" class="section-container"></section>
            <section id="accounts" class="section-container"></section>
            <section id="finances" class="section-container"></section>
            <section id="news" class="section-container"></section>
            <section id="config" class="section-container"></section>
            `;
    }
    
    function getAllModalsHTML() {
        return `
            <div id="image-modal" class="image-modal fixed inset-0 hidden items-center justify-center z-[2002]"><span class="image-modal-close" id="image-modal-close-btn">×</span><img class="image-modal-content" id="modal-image-content"></div>
            <div id="global-calendar-popup" class="absolute z-50 mt-1 p-3 rounded-md shadow-lg hidden" style="border: 1px solid var(--surface-light); width: 280px; background-color: var(--surface);"><div class="flex justify-between items-center mb-2"><button id="popup-cal-prev-month-btn" class="px-2 py-1 hover:bg-surface-light rounded text-sm"><i class="fas fa-chevron-left"></i></button><div id="popup-cal-current-month-year" class="font-semibold text-sm"></div><button id="popup-cal-next-month-btn" class="px-2 py-1 hover:bg-surface-light rounded text-sm"><i class="fas fa-chevron-right"></i></button></div><div class="grid grid-cols-7 gap-1 text-center text-xs mb-1 text-text-secondary"><div>Lu</div><div>Ma</div><div>Mi</div><div>Ju</div><div>Vi</div><div>Sa</div><div>Do</div></div><div id="popup-cal-days-grid" class="grid grid-cols-7 gap-1 text-center"></div><div class="mt-3 space-y-1"><button id="popup-cal-select-week-btn" class="w-full text-xs py-1.5 px-2 bg-surface-light rounded">Semana del Mes Visible</button><button id="popup-cal-select-month-btn" class="w-full text-xs py-1.5 px-2 bg-surface-light rounded">Mes Visible Completo</button><button id="popup-cal-select-semester-btn" class="w-full text-xs py-1.5 px-2 bg-surface-light rounded">Semestre Actual</button><button id="popup-cal-select-year-btn" class="w-full text-xs py-1.5 px-2 bg-surface-light rounded">Año Actual</button><button id="popup-cal-clear-filter-btn" class="w-full text-xs py-1.5 px-2 bg-red-700 hover:bg-red-600 rounded mt-2">Limpiar Filtro de Fecha</button></div></div>
            <div id="day-detail-modal" class="fixed inset-0 hidden items-center justify-center z-[2003] px-4 py-6"><div class="p-5 rounded-lg shadow-xl w-full max-w-3xl text-text relative flex flex-col max-h-[90vh]"><div class="flex justify-between items-center mb-4 pb-3 border-b border-surface-light"><h3 id="day-modal-title" class="text-xl font-semibold">Trades del DD/MM/YYYY</h3><button id="close-day-modal-icon" class="text-2xl text-text-secondary hover:text-text leading-none -mt-1">×</button></div><div class="mb-4 grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-x-4 gap-y-3 text-sm"><div>P&L Total: <span id="day-total-pl-header" class="font-semibold"></span></div><div>Trades Totales: <span id="day-total-trades-header" class="font-semibold"></span></div><div>Win Rate: <span id="day-win-rate-header" class="font-semibold"></span></div><div>Ganadores: <span id="day-winners-header" class="font-semibold"></span></div><div>Perdedores: <span id="day-losers-header" class="font-semibold"></span></div><div>Volumen: <span id="day-volume-header" class="font-semibold"></span></div><div class="md:col-span-1">Profit Factor: <span id="day-profit-factor-header" class="font-semibold"></span></div></div><div class="overflow-y-auto flex-grow mb-4 border border-surface-light rounded-md"><table class="w-full text-left text-sm"><thead class="sticky top-0 bg-surface z-10"><tr><th class="py-2 px-3">Hora Entrada</th><th class="py-2 px-3">Símbolo</th><th class="py-2 px-3">Tipo</th><th class="py-2 px-3">P&L Neto</th><th class="py-2 px-3">Hora Salida</th></tr></thead><tbody id="day-modal-table-body" class="divide-y divide-surface"></tbody></table></div><div class="text-right pt-4 border-t border-surface-light"><button id="close-day-modal-btn" class="primary px-4 py-2">Cerrar</button></div></div></div>
            `;
    }

    async function initializeJournal() {
        const appContainerWrapper = document.querySelector('.app-container-wrapper');
        const loadingSpinner = document.getElementById('loading');

        try {
            const { data, error } = await supabase.auth.signInWithPassword({
                email: DEV_USER_EMAIL,
                password: DEV_USER_PASSWORD,
            });

            if (error) {
                document.body.innerHTML = `<div class="text-red-500 text-center p-8 text-xl">Error de autenticación: ${error.message}.<br><br>Verifica que tus credenciales en el script (DEV_USER_EMAIL y DEV_USER_PASSWORD) son correctas y que el usuario existe en Supabase.</div>`;
                loadingSpinner.style.display = 'none';
                return;
            }

            if (data.session) {
                DB.user = data.session.user;
                appContainerWrapper.style.display = 'block';
                appContainerWrapper.querySelector('.app-container').innerHTML = getAppHTML(); 
                documento.getElementById('sección de autenticación').HTML interno = `<span class="text-white text-sm mr-4">${Base de datos.usuario.correo electrónico}</span><button id="sign-out-btn" class="botón peligro">Salir</button>`;
                
                await datos del usuario de carga();
                initAllAppMódulos();
                
                const Tabla activa inicial = documento.Selector de consultas('.nav-tab.active');
                si (Tabla activa inicial) {
                    const ID de objetivo inicial = Tabla activa inicial.dataset.objetivo;
                    documento.getElementById(ID de objetivo inicial).lista de clases.agregar('activo');
                    refrescarTodas las vistas();
                }
            }
        } atrapar (e) {
            documento.cuervo.HTML interno = `<div class="text-red-500 text-center p-8 text-xl">Ha ocurrido un error fatal durante la inicialización. Revisa la consola para más detalles.</div>`;
            consola.error("Error de inicialización fatal:", e);
        } finalmente {
            spinner de carga.estilo.visualizar = 'ninguno';
        }
    }
    
    async función Empresa Manéjar() {
        Más Cargando(verdederadero);
        const { error } = await supabase.auth.firmar();
        si (error) {
            consola.error("Error al cerrar sesión:", error.mensaje);
            alerta("Error al cerrar sesión: " + error.mensaje);
        } else {
            alerta("Tiene cerrado sesión.");
            ubicación.reload();
        }
        Más Cargando(falso);
    }

    función initAllAppMódulos() {
        documento.getElementById('cerrar sesión-btn').addEventListener('clic', Empresa Manéjar);
        
        initDashboard(); análisis inicial(); calendario de inicio(); Operaciones de inicio();
        cuentas de inicio(); initConfig(); initFinances();
        ventana emergente de calendario global init(); initImageModal();

        const pestañas = documento.Selector de consultasTodos('.nav-tab');
        const secciones = documento.Selector de consultasTodos('.contenedor de secciones');
        pestañas.para cada uno(tab => {
            tab.addEventListener('clic', () => {
                const targetId = tab.dataset.objetivo;
                pestañas.para cada uno(t => t.lista de clases.eliminatorio('activo'));
                secciones.para cada uno(s => s.lista de clases.eliminatorio('activo'));
                tab.lista de clases.agregar('activo');
                documento.getElementById(targetId).lista de clases.agregar('activo');
                refrescarTodas las vistas();
                ventana.desplazarse hasta({ top: 0, comportamiento: 'suave' });
            });
        });
    }

    // El resto del script sigue aquí...
    
    </script>
</cuervo>
</html>
